{% extends "ui/base.html" %}

{% block title %}Compras · Nueva OC | ERPWeb{% endblock %}

{% block content %}
<div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
  <div>
    <h2 class="h4 mb-1">Compras · Nueva Orden de Compra</h2>
    <p class="text-muted mb-0">
      Escribí el producto y seleccioná desde las sugerencias. El <strong>costo unitario</strong> se completa automático desde la base.
    </p>
  </div>
  <div>
    <a class="btn btn-outline-secondary" href="{% url 'ui:purchases_orders' %}">Volver</a>
  </div>
</div>

{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} mb-2">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<form method="post" class="mt-3">
  {% csrf_token %}

  <div class="card mb-3">
    <div class="card-body">
      <h3 class="h6 mb-3">Encabezado</h3>

      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <label class="form-label">{{ form.supplier.label }}</label>
          {{ form.supplier }}
          {% if form.supplier.errors %}
            <div class="text-danger small mt-1">{{ form.supplier.errors }}</div>
          {% endif %}
        </div>

        <div class="col-12 col-lg-6">
          <label class="form-label">{{ form.note.label }}</label>
          {{ form.note }}
          {% if form.note.errors %}
            <div class="text-danger small mt-1">{{ form.note.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h3 class="h6 mb-3">Líneas</h3>

      {% if formset.non_form_errors %}
        <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
      {% endif %}

      {{ formset.management_form }}

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Producto</th>
              <th class="text-end">Cantidad</th>
              <th class="text-end">Costo unit.</th>
              <th class="text-end">Total</th>
              <th class="text-end">Eliminar</th>
            </tr>
          </thead>
          <tbody id="lines-tbody">
            {% for f in formset.forms %}
              <tr class="line-row" data-row-prefix="{{ f.prefix }}">
                <td style="min-width: 360px;">
                  <div class="position-relative">
                    {{ f.product_query }}
                    {{ f.product_id }}
                    {{ f.unit_cost_display }}
                  </div>
                  {% if f.product_id.errors %}
                    <div class="text-danger small mt-1">{{ f.product_id.errors }}</div>
                  {% endif %}
                </td>

                <td class="text-end" style="max-width: 140px;">
                  {{ f.quantity }}
                  {% if f.quantity.errors %}
                    <div class="text-danger small mt-1">{{ f.quantity.errors }}</div>
                  {% endif %}
                </td>

                <td class="text-end" style="max-width: 220px;">
                  <div class="fw-semibold" data-unit-cost-text>—</div>
                  <div class="small text-muted">Auto (DB)</div>
                </td>

                <td class="text-end" style="max-width: 220px;">
                  <div class="fw-semibold" data-line-total-text>—</div>
                  <div class="small text-muted">Cant. × Unit.</div>
                </td>

                <td class="text-end" style="max-width: 120px;">
                  <button
                    type="button"
                    class="btn btn-link p-0 line-remove-btn"
                    aria-label="Eliminar línea"
                    title="Eliminar"
                    style="text-decoration:none; font-size: 16px; line-height: 1;"
                  >❌</button>

                  <span class="d-none">
                    {{ f.DELETE }}
                  </span>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- ✅ Total General (dinámico) -->
      <div class="d-flex justify-content-end mt-2">
        <div class="px-3 py-2 border rounded bg-light">
          <span class="text-muted me-2">Total OC:</span>
          <strong id="po-grand-total">$0,00</strong>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button type="button" class="btn btn-outline-primary" id="add-line-btn">+ Agregar línea</button>
      </div>
    </div>
  </div>

  <div class="d-flex gap-2 mt-3">
    <button class="btn btn-success">Guardar OC</button>
    <a class="btn btn-outline-secondary" href="{% url 'ui:purchases_orders' %}">Cancelar</a>
  </div>
</form>

<script>
(function() {
  const SEARCH_URL = "{% url 'ui:products_search' %}";
  const DETAIL_URL_BASE = "{% url 'ui:product_detail' 1 %}".replace("/1/", "/"); // hack: base path

  // --- Helpers moneda / parse ---
  function parseMoneyToFloat(s) {
    if (s == null) return 0;
    const cleaned = String(s).replace(/\$/g, "").replace(/\s/g, "").trim();
    const n = parseFloat(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function formatMoneyARS(n) {
    try {
      return new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(n || 0);
    } catch(e) {
      return `$${(n || 0).toFixed(2)}`;
    }
  }

  function getQty(row) {
    const prefix = row.getAttribute("data-row-prefix");
    const el = row.querySelector(`input[name="${prefix}-quantity"]`);
    if (!el) return 0;
    const n = parseFloat((el.value || "").trim());
    return Number.isFinite(n) ? n : 0;
  }

  function getUnitCost(row) {
    const prefix = row.getAttribute("data-row-prefix");
    const hidden = row.querySelector(`input[name="${prefix}-unit_cost_display"]`);
    if (hidden && (hidden.value || "").trim() !== "") {
      return parseMoneyToFloat(hidden.value);
    }
    const txt = row.querySelector("[data-unit-cost-text]");
    if (!txt) return 0;
    return parseMoneyToFloat(txt.textContent);
  }

  function isDeleted(row) {
    const del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
    return !!(del && del.checked);
  }

  function updateLineTotal(row) {
    const totalEl = row.querySelector("[data-line-total-text]");
    if (!totalEl) return;

    if (isDeleted(row) || row.style.display === "none") {
      totalEl.textContent = "—";
      return;
    }

    const qty = getQty(row);
    const unit = getUnitCost(row);
    const total = qty * unit;

    if (!qty || !unit) {
      totalEl.textContent = "—";
      return;
    }

    totalEl.textContent = formatMoneyARS(total);
  }

  function updateGrandTotal() {
    let sum = 0;
    document.querySelectorAll("tr.line-row").forEach((row) => {
      if (row.style.display === "none") return;
      if (isDeleted(row)) return;

      const qty = getQty(row);
      const unit = getUnitCost(row);
      if (!qty || !unit) return;

      sum += (qty * unit);
    });

    const el = document.getElementById("po-grand-total");
    if (el) el.textContent = formatMoneyARS(sum);
  }

  function recalcAll() {
    document.querySelectorAll("tr.line-row").forEach(updateLineTotal);
    updateGrandTotal();
  }

  // ✅ Un solo “dropdown” global, montado en <body> con position:fixed (no lo corta ningún overflow)
  const dropdown = document.createElement("div");
  dropdown.className = "list-group shadow";
  dropdown.style.position = "fixed";
  dropdown.style.zIndex = "99999";
  dropdown.style.maxHeight = "260px";
  dropdown.style.overflow = "auto";
  dropdown.style.display = "none";
  dropdown.style.background = "white";
  document.body.appendChild(dropdown);

  let active = null; // { row, input, productId, costHidden, costText }

  function debounce(fn, ms) {
    let t = null;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), ms);
    }
  }

  function hideDropdown() {
    dropdown.style.display = "none";
    dropdown.innerHTML = "";
    active = null;
  }

  function placeDropdownUnder(inputEl) {
    const r = inputEl.getBoundingClientRect();
    dropdown.style.left = r.left + "px";
    dropdown.style.top = r.bottom + "px";
    dropdown.style.width = r.width + "px";
  }

  async function fetchProductDetail(productId) {
    const url = `${DETAIL_URL_BASE}${productId}/`;
    const res = await fetch(url, { headers: {"X-Requested-With": "XMLHttpRequest"} });
    if (!res.ok) return null;
    return await res.json();
  }

  async function restoreCostIfSelected(rowCtx) {
    const pid = (rowCtx.productId.value || "").trim();
    if (!pid) return;

    if (rowCtx.costText && rowCtx.costText.textContent && rowCtx.costText.textContent !== "—") {
      updateLineTotal(rowCtx.row);
      updateGrandTotal();
      return;
    }

    const data = await fetchProductDetail(pid);
    if (!data || !data.cost) return;

    rowCtx.costText.textContent = `$${data.cost}`;
    if (rowCtx.costHidden) rowCtx.costHidden.value = data.cost;

    updateLineTotal(rowCtx.row);
    updateGrandTotal();
  }

  async function searchAndRender() {
    if (!active) return;
    const q = (active.input.value || "").trim();
    if (q.length < 2) {
      hideDropdown();
      return;
    }

    try {
      const res = await fetch(`${SEARCH_URL}?q=${encodeURIComponent(q)}`, {
        headers: {"X-Requested-With": "XMLHttpRequest"}
      });
      if (!res.ok) {
        hideDropdown();
        return;
      }
      const data = await res.json();
      const items = (data && data.items) ? data.items : [];
      if (!items.length) {
        hideDropdown();
        return;
      }

      dropdown.innerHTML = "";
      items.forEach(it => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "list-group-item list-group-item-action";
        btn.textContent = it.label + (it.cost ? ` · $${it.cost}` : "");
        btn.addEventListener("click", () => {
          active.input.value = it.label;
          active.productId.value = it.id;

          active.costText.textContent = it.cost ? `$${it.cost}` : "—";
          if (active.costHidden) active.costHidden.value = it.cost || "";

          hideDropdown();

          updateLineTotal(active.row);
          updateGrandTotal();
        });
        dropdown.appendChild(btn);
      });

      placeDropdownUnder(active.input);
      dropdown.style.display = "block";
    } catch (e) {
      hideDropdown();
    }
  }

  const debouncedSearch = debounce(searchAndRender, 160);

  function setupRow(row) {
    const prefix = row.getAttribute("data-row-prefix");
    const queryInput = row.querySelector(`input[name="${prefix}-product_query"]`);
    const productIdInput = row.querySelector(`input[name="${prefix}-product_id"]`);
    const costHidden = row.querySelector(`input[name="${prefix}-unit_cost_display"]`);
    const costText = row.querySelector("[data-unit-cost-text]");

    const rowCtx = { row, input: queryInput, productId: productIdInput, costHidden, costText };

    restoreCostIfSelected(rowCtx);

    queryInput.addEventListener("input", () => {
      productIdInput.value = "";
      if (costHidden) costHidden.value = "";
      if (costText) costText.textContent = "—";
      updateLineTotal(row);
      updateGrandTotal();
    });

    queryInput.addEventListener("focus", () => {
      active = rowCtx;
      placeDropdownUnder(queryInput);
      debouncedSearch();
    });

    queryInput.addEventListener("keyup", () => {
      active = rowCtx;
      placeDropdownUnder(queryInput);
      debouncedSearch();
    });

    const qtyInput = row.querySelector(`input[name="${prefix}-quantity"]`);
    if (qtyInput) {
      qtyInput.addEventListener("input", () => { updateLineTotal(row); updateGrandTotal(); });
      qtyInput.addEventListener("change", () => { updateLineTotal(row); updateGrandTotal(); });
    }

    window.addEventListener("scroll", () => {
      if (active && active.input === queryInput && dropdown.style.display === "block") {
        placeDropdownUnder(queryInput);
      }
    }, { passive: true });
  }

  // setup inicial
  document.querySelectorAll("tr.line-row").forEach((r) => setupRow(r));
  recalcAll();

  // cerrar dropdown al click afuera o escape
  document.addEventListener("click", (ev) => {
    if (!dropdown.contains(ev.target) && !(active && active.row.contains(ev.target))) {
      hideDropdown();
    }
  });
  document.addEventListener("keydown", (ev) => {
    if (ev.key === "Escape") hideDropdown();
  });

  // Agregar línea (clonado + reindex)
  const btn = document.getElementById("add-line-btn");
  const tbody = document.getElementById("lines-tbody");

  function updateTotalForms(newCount) {
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");
    if (totalForms) totalForms.value = String(newCount);
  }

  function isNewRow(row) {
    // Si NO tiene input hidden id_form-#-id => es nueva (no persistida)
    const prefix = row.getAttribute("data-row-prefix");
    const idField = row.querySelector(`input[name="${prefix}-id"]`);
    return !idField;
  }

  function markDeletedAndHide(row) {
    const del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
    if (del) del.checked = true;
    row.style.display = "none";
  }

  function reindexAllRows() {
    const rows = Array.from(tbody.querySelectorAll("tr.line-row"))
      .filter(r => r.style.display !== "none"); // solo visibles

    rows.forEach((row, idx) => {
      const oldPrefix = row.getAttribute("data-row-prefix");
      const newPrefix = `form-${idx}`;
      if (oldPrefix === newPrefix) return;

      row.setAttribute("data-row-prefix", newPrefix);

      row.querySelectorAll("input, select, textarea, label").forEach(el => {
        if (el.name) el.name = el.name.replace(oldPrefix, newPrefix);
        if (el.id) el.id = el.id.replace(oldPrefix, newPrefix);
        if (el.htmlFor) el.htmlFor = el.htmlFor.replace(oldPrefix, newPrefix);
      });
    });

    updateTotalForms(rows.length);

    // Re-setup listeners y recalcular
    rows.forEach((row) => setupRow(row));
    recalcAll();
  }

  // Eliminar con ❌:
  // - si es fila original -> DELETE + hide (safe)
  // - si es fila nueva -> remove DOM + reindex + TOTAL_FORMS (para no romper agregar)
  document.addEventListener("click", (ev) => {
    const b = ev.target.closest(".line-remove-btn");
    if (!b) return;
    const row = b.closest("tr.line-row");
    if (!row) return;

    if (isNewRow(row)) {
      row.remove();
      reindexAllRows();
      return;
    }

    markDeletedAndHide(row);
    recalcAll();
  });

  btn.addEventListener("click", function() {
    const visibleRows = Array.from(tbody.querySelectorAll("tr.line-row"))
      .filter(r => r.style.display !== "none");

    // Siempre clonamos la última visible
    const last = visibleRows[visibleRows.length - 1];
    if (!last) return;

    const clone = last.cloneNode(true);

    const newIndex = visibleRows.length;
    const oldPrefix = clone.getAttribute("data-row-prefix");
    const newPrefix = `form-${newIndex}`;
    clone.setAttribute("data-row-prefix", newPrefix);

    clone.querySelectorAll("input, select, textarea, label").forEach(el => {
      if (el.name) el.name = el.name.replace(oldPrefix, newPrefix);
      if (el.id) el.id = el.id.replace(oldPrefix, newPrefix);
      if (el.htmlFor) el.htmlFor = el.htmlFor.replace(oldPrefix, newPrefix);
    });

    // Limpiar valores
    clone.querySelectorAll("input").forEach(el => {
      if (el.type === "checkbox") el.checked = false;
      else el.value = "";
    });

    const costText = clone.querySelector("[data-unit-cost-text]");
    if (costText) costText.textContent = "—";

    const totalText = clone.querySelector("[data-line-total-text]");
    if (totalText) totalText.textContent = "—";

    // Borrar solo errores reales
    clone.querySelectorAll("div.text-danger.small").forEach(el => el.remove());

    // Asegurar visible
    clone.style.display = "";

    tbody.appendChild(clone);
    updateTotalForms(visibleRows.length + 1);
    setupRow(clone);
    recalcAll();
  });
})();
</script>
{% endblock %}
