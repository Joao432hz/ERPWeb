{% extends "ui/base.html" %}
{% block title %}Modificar producto #{{ p.id }} | ERPWeb{% endblock %}

{% block content %}
<div class="d-flex align-items-start justify-content-between gap-3 flex-wrap mb-3">
  <div>
    <h2 class="h4 mb-1">Stock · Modificar producto #{{ p.id }}</h2>
    <div class="text-muted small">Editá los datos. El stock se administra por movimientos (IN/OUT).</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'ui:stock_product_detail' p.id %}">Volver</a>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

      {# ✅ Imagen sugerida desde Smart Lookup (se persiste por POST) #}
      <input type="hidden" name="image_url" id="id_image_url" value="">

      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">SKU</label>

          <div class="input-group">
            {{ form.sku }}
            <button
              id="smartSkuBtn"
              class="btn btn-outline-primary"
              type="button"
              title="Búsqueda inteligente"
              aria-label="Búsqueda inteligente"
            >✨</button>
          </div>

          <div id="smartHint" class="text-muted small mt-1" style="display:none;">
            Algunos campos fueron sugeridos automáticamente. Revisá antes de guardar.
          </div>

          {# Preview imagen sugerida (URL) #}
          <div id="formImgWrap" class="mt-2 d-none">
            <div class="d-flex align-items-center gap-2">
              <img
                id="formImgPreview"
                alt="Imagen sugerida"
                class="rounded border"
                style="max-height:72px; max-width:72px;"
              >
              <div class="d-flex flex-column gap-1">
                <a id="formImgLink" href="#" target="_blank" rel="noopener" class="small">Abrir imagen</a>
                <button id="formImgClear" type="button" class="btn btn-sm btn-outline-danger">Quitar</button>
              </div>
            </div>
            <div class="text-muted small mt-1">
              Si guardás sin subir archivo, se intentará reemplazar la imagen con esta URL.
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Código interno</label>
          {{ form.internal_code }}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Estado</label>
          {{ form.status }}
        </div>

        <div class="col-12">
          <label class="form-label">Nombre</label>
          {{ form.name }}
        </div>

        <div class="col-12">
          <label class="form-label">Descripción</label>
          {{ form.description }}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Unidad de medida</label>
          {{ form.unit_of_measure }}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Costo unitario</label>
          {{ form.purchase_cost }}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Precio de venta</label>
          {{ form.sale_price }}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Impuesto</label>
          {{ form.tax_type }}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Valor impuesto (%)</label>
          {{ form.tax_rate }}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Categoría</label>
          {{ form.category }}
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Marca</label>
          {{ form.brand }}
        </div>

        <div class="col-12">
          <hr class="my-2">
          <h3 class="h6 mb-2">Imagen</h3>

          {% if product_image_url %}
            <div class="d-flex align-items-center gap-3 mb-2">
              <a href="{{ product_image_url }}" target="_blank" rel="noopener">
                <img
                  src="{{ product_image_url }}"
                  alt="Imagen actual"
                  class="rounded border"
                  style="max-width:120px; max-height:120px;"
                >
              </a>
              <div class="small">
                <div class="mb-1">
                  <a href="{{ product_image_url }}" target="_blank" rel="noopener">Abrir archivo</a>
                </div>
                <div class="text-muted">
                  Fuente:
                  {% if product_image_source_url %}
                    <a href="{{ product_image_source_url }}" target="_blank" rel="noopener">ver URL</a>
                  {% else %}
                    -
                  {% endif %}
                </div>
              </div>
            </div>
          {% else %}
            <div class="text-muted small mb-2">No hay imagen cargada.</div>
          {% endif %}

          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-6">
              <label class="form-label">Subir nueva imagen (archivo)</label>
              {{ form.image }}
              <div class="text-muted small mt-1">Si subís un archivo, tendrá prioridad sobre la URL sugerida.</div>
            </div>

            <div class="col-12 col-md-6">
              <div class="form-check mt-4">
                {{ form.remove_image }}
                <label class="form-check-label" for="id_remove_image">Quitar imagen</label>
              </div>
              <div class="text-muted small">Quita la imagen actual y limpia la fuente.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-4">
        <button class="btn btn-primary" type="submit">Guardar cambios</button>
        <a class="btn btn-outline-secondary" href="{% url 'ui:stock_product_detail' p.id %}">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<!-- Modal Smart Lookup (idéntico al create) -->
<div class="modal fade" id="smartLookupModal" tabindex="-1" aria-labelledby="smartLookupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="smartLookupModalLabel">Búsqueda inteligente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div id="smartLookupStatus" class="d-flex align-items-center gap-2">
          <div id="smartLookupStatusLoading" class="d-flex align-items-center gap-2">
            <div class="spinner-border" role="status" aria-hidden="true"></div>
            <div>Buscando información…</div>
          </div>

          <div id="smartLookupStatusDone" class="d-none align-items-center gap-2 text-success">
            <span style="font-size:18px; line-height:1;">✅</span>
            <div>Búsqueda finalizada</div>
          </div>
        </div>

        <div id="smartLookupError" class="alert alert-danger mt-3" style="display:none;"></div>

        <div id="smartLookupResult" class="mt-3" style="display:none;">
          <div class="alert alert-warning mb-3">
            <strong>Datos sugeridos</strong> (revisá antes de aplicar). No se inventa información.
          </div>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <div class="text-muted small">Código / SKU</div>
              <div id="res_codigo" class="fw-semibold">-</div>
            </div>
            <div class="col-12 col-md-6">
              <div class="text-muted small">Nivel de confianza</div>
              <div id="res_conf" class="fw-semibold">-</div>
            </div>
            <div class="col-12">
              <div class="text-muted small">Nombre</div>
              <div id="res_nombre" class="fw-semibold">-</div>
            </div>
            <div class="col-12 col-md-6">
              <div class="text-muted small">Marca</div>
              <div id="res_marca" class="fw-semibold">-</div>
            </div>
            <div class="col-12 col-md-6">
              <div class="text-muted small">Categoría</div>
              <div id="res_categoria" class="fw-semibold">-</div>
            </div>
            <div class="col-12">
              <div class="text-muted small">Descripción</div>
              <div id="res_desc" style="white-space:pre-wrap;">-</div>
            </div>

            <div class="col-12 col-md-6">
              <div class="text-muted small">Peso / Volumen</div>
              <div id="res_peso" class="fw-semibold">-</div>
            </div>

            <div class="col-12 col-md-6">
              <div class="text-muted small">Imagen</div>
              <div class="d-flex align-items-center gap-2">
                <img id="res_img" alt="Imagen producto" style="max-height:72px; max-width:72px; display:none;" class="rounded border">
                <a id="res_img_link" href="#" target="_blank" rel="noopener" style="display:none;">Abrir imagen</a>
                <span id="res_img_none" class="text-muted">-</span>
              </div>
            </div>

            <div class="col-12">
              <div class="text-muted small">Fuente(s)</div>
              <ul id="res_sources" class="mb-0"></ul>
            </div>
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <div class="me-auto text-muted small" id="smartLookupFooterNote"></div>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button class="btn btn-primary" id="smartApplyBtn" type="button" disabled>Aplicar al formulario</button>
      </div>

    </div>
  </div>
</div>

<script>
window.addEventListener("load", function () {
  const SMART_LOOKUP_URL = "/api/stock/products/smart-lookup/";

  const skuInput = document.getElementById("id_sku");
  const btn = document.getElementById("smartSkuBtn");
  const hint = document.getElementById("smartHint");

  const hiddenImageUrl = document.getElementById("id_image_url");
  const formImgWrap = document.getElementById("formImgWrap");
  const formImgPreview = document.getElementById("formImgPreview");
  const formImgLink = document.getElementById("formImgLink");
  const formImgClear = document.getElementById("formImgClear");

  const modalEl = document.getElementById("smartLookupModal");
  const modal = new bootstrap.Modal(modalEl);

  const statusEl = document.getElementById("smartLookupStatus");
  const statusLoadingEl = document.getElementById("smartLookupStatusLoading");
  const statusDoneEl = document.getElementById("smartLookupStatusDone");

  const errorEl = document.getElementById("smartLookupError");
  const resultEl = document.getElementById("smartLookupResult");
  const applyBtn = document.getElementById("smartApplyBtn");
  const footerNote = document.getElementById("smartLookupFooterNote");

  let lastNormalized = null;

  function getCookie(name) {
    const m = document.cookie.match(new RegExp("(^|;\\s*)" + name + "=([^;]+)"));
    return m ? decodeURIComponent(m[2]) : null;
  }

  function setStatus(state) {
    statusEl.style.display = "flex";
    if (state === "loading") {
      statusLoadingEl.classList.remove("d-none");
      statusDoneEl.classList.add("d-none");
      return;
    }
    if (state === "done") {
      statusLoadingEl.classList.add("d-none");
      statusDoneEl.classList.remove("d-none");
      return;
    }
  }

  function hideStatus() {
    statusEl.style.display = "none";
  }

  function showProcessing() {
    setStatus("loading");
    errorEl.style.display = "none";
    resultEl.style.display = "none";
    footerNote.textContent = "";
    applyBtn.disabled = true;
    lastNormalized = null;
  }

  function showError(msg) {
    hideStatus();
    resultEl.style.display = "none";
    errorEl.style.display = "block";
    errorEl.textContent = msg;
    applyBtn.disabled = true;
  }

  function setText(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = (value === null || value === undefined || String(value).trim() === "") ? "-" : String(value);
  }

  function clearSources() {
    const ul = document.getElementById("res_sources");
    ul.innerHTML = "";
  }

  function addSourceItem(label, url) {
    const ul = document.getElementById("res_sources");
    const li = document.createElement("li");
    if (url) {
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.textContent = label || url;
      li.appendChild(a);
    } else {
      li.textContent = label || "-";
    }
    ul.appendChild(li);
  }

  function setFormImage(url) {
    if (!hiddenImageUrl) return;

    const u = (url || "").trim();
    hiddenImageUrl.value = u;

    if (u) {
      if (formImgPreview) formImgPreview.src = u;
      if (formImgLink) formImgLink.href = u;
      if (formImgWrap) formImgWrap.classList.remove("d-none");
    } else {
      if (formImgPreview) formImgPreview.removeAttribute("src");
      if (formImgLink) formImgLink.href = "#";
      if (formImgWrap) formImgWrap.classList.add("d-none");
    }
  }

  function renderResult(payload) {
    const data = payload && payload.data ? payload.data : null;
    if (!data) {
      showError("No se encontraron datos. Podés completar manualmente.");
      return;
    }

    lastNormalized = data;

    setStatus("done");

    errorEl.style.display = "none";
    resultEl.style.display = "block";

    setText("res_codigo", data.codigo_barra || payload.barcode || (skuInput ? skuInput.value : ""));
    setText("res_nombre", data.nombre);
    setText("res_marca", data.marca);
    setText("res_categoria", data.categoria);
    setText("res_desc", data.descripcion);
    setText("res_peso", data.peso_volumen);

    const conf = (data.nivel_confianza === null || data.nivel_confianza === undefined)
      ? "-"
      : String(data.nivel_confianza);
    setText("res_conf", conf);

    const img = document.getElementById("res_img");
    const imgLink = document.getElementById("res_img_link");
    const imgNone = document.getElementById("res_img_none");

    if (data.imagen_url) {
      img.src = data.imagen_url;
      img.style.display = "block";
      imgLink.href = data.imagen_url;
      imgLink.style.display = "inline";
      imgNone.style.display = "none";
    } else {
      img.style.display = "none";
      imgLink.style.display = "none";
      imgNone.style.display = "inline";
    }

    clearSources();
    const sources = payload.sources || [];
    if (sources.length) {
      sources.forEach(s => addSourceItem((s.name || s.type || "Fuente"), (s.url || null)));
    } else {
      addSourceItem(data.fuente_datos || "Sin fuente detallada", null);
    }

    const cached = payload.cached ? " (desde cache)" : "";
    footerNote.textContent = `Resultado listo${cached}.`;

    applyBtn.disabled = false;
  }

  function markSuggested(el) {
    if (!el) return;
    el.classList.add("border-warning", "border-2");
  }

  function applyToForm(data) {
    if (!data) return;

    const mapping = [
      ["nombre", "id_name"],
      ["marca", "id_brand"],
      ["categoria", "id_category"],
      ["descripcion", "id_description"],
    ];

    let anyApplied = false;

    mapping.forEach(([key, id]) => {
      const v = data[key];
      const el = document.getElementById(id);
      if (!el) return;

      // No pisar si el usuario ya escribió algo
      const current = (el.value || "").trim();
      if (current) return;

      if (v !== null && v !== undefined && String(v).trim() !== "") {
        el.value = String(v);
        markSuggested(el);
        anyApplied = true;
      }
    });

    const currentImg = hiddenImageUrl ? (hiddenImageUrl.value || "").trim() : "";
    if (!currentImg && data.imagen_url) {
      setFormImage(data.imagen_url);
      anyApplied = true;
    }

    if (anyApplied) {
      hint.style.display = "block";
    }
  }

  async function doLookup() {
    const sku = (skuInput ? skuInput.value : "").trim();
    if (!sku) {
      alert("Ingresá un SKU");
      return;
    }

    modal.show();
    showProcessing();

    try {
      const csrftoken = getCookie("csrftoken") || "";

      const res = await fetch(SMART_LOOKUP_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ barcode: sku })
      });

      let payload = null;
      const contentType = (res.headers.get("content-type") || "").toLowerCase();
      if (contentType.includes("application/json")) {
        payload = await res.json();
      } else {
        const txt = await res.text();
        payload = { detail: txt };
      }

      if (!res.ok) {
        const detail = payload && payload.detail ? payload.detail : ("Error HTTP " + res.status);
        const errType = payload && payload.error_type ? (" (" + payload.error_type + ")") : "";
        const statusCode = payload && payload.status_code ? (" · status_code=" + payload.status_code) : "";
        showError(detail + errType + statusCode);
        return;
      }

      renderResult(payload);

    } catch (e) {
      showError("No se pudo realizar la búsqueda. Detalle: " + (e && e.message ? e.message : e));
    }
  }

  btn.addEventListener("click", doLookup);

  applyBtn.addEventListener("click", function () {
    if (!lastNormalized) return;
    applyToForm(lastNormalized);
    modal.hide();
  });

  if (formImgClear) {
    formImgClear.addEventListener("click", function () {
      setFormImage("");
    });
  }

  if (skuInput) {
    skuInput.addEventListener("keydown", function (ev) {
      if (ev.key === "Enter" && (ev.ctrlKey || ev.metaKey)) {
        ev.preventDefault();
        doLookup();
      }
    });
  }
});
</script>
{% endblock %}
