{% extends "ui/base.html" %}

{% block title %}Compras · PO#{{ po.id }} | ERPWeb{% endblock %}

{% block content %}
<div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
  <div>
    <h2 class="h4 mb-1">Compras · PO#{{ po.id }}</h2>
    <div class="text-muted">
      Proveedor: <strong>{{ po.supplier.name }}</strong>
      · Estado: <strong>{{ po.status }}</strong>
      · Total: <strong>{{ po.total_amount }}</strong>
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'ui:purchases_orders' %}">Volver</a>

    {% if po.status == "DRAFT" and can_purchases_confirm %}
      <form method="post" action="{% url 'ui:purchases_order_confirm' po.id %}">
        {% csrf_token %}
        <button class="btn btn-primary">Confirmar</button>
      </form>
    {% endif %}

    {% if po.status == "CONFIRMED" and can_purchases_receive %}
      <form method="post" action="{% url 'ui:purchases_order_receive' po.id %}">
        {% csrf_token %}
        <button class="btn btn-success">Recibir</button>
      </form>
    {% endif %}

    {% if po.status != "RECEIVED" and po.status != "CANCELLED" and can_purchases_cancel %}
      <form method="post" action="{% url 'ui:purchases_order_cancel' po.id %}">
        {% csrf_token %}
        <button class="btn btn-outline-danger">Cancelar</button>
      </form>
    {% endif %}
  </div>
</div>

{% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} mb-2">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<hr class="my-4">

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-body">
        <h3 class="h6 mb-3">Datos</h3>
        <div class="small text-muted">Creado por</div>
        <div class="mb-2">{{ po.created_by }} · {{ po.created_at }}</div>

        <div class="small text-muted">Confirmación</div>
        <div class="mb-2">
          {% if po.confirmed_at %}{{ po.confirmed_by }} · {{ po.confirmed_at }}{% else %}-{% endif %}
        </div>

        <div class="small text-muted">Recepción</div>
        <div>
          {% if po.received_at %}{{ po.received_by }} · {{ po.received_at }}{% else %}-{% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-body">
        <h3 class="h6 mb-3">Nota</h3>
        <div class="text-muted">{{ po.note|default:"(sin nota)" }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-body">
    <h3 class="h6 mb-3">Líneas</h3>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Producto</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">Costo unit.</th>
            <th class="text-end">Total línea</th>
          </tr>
        </thead>
        <tbody>
          {% for ln in lines %}
            <tr>
              <td>{{ ln.product.sku }}</td>
              <td>{{ ln.product.name }}</td>
              <td class="text-end">{{ ln.quantity }}</td>
              <td class="text-end">{{ ln.unit_cost }}</td>
              <td class="text-end">{{ ln.line_total }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="5" class="text-muted">Sin líneas.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
